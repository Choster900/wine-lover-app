<template>
    <div class="s-py-50" data-aos="fade-up">
        <div class="container-fluid">
            <div class="max-w-[1720px] mx-auto flex justify-between gap-10 flex-col lg:flex-row">
                <div class="w-full lg:w-[58%]">
                    <div class="relative product-dtls-wrapper">
                        <div class="product-dtls-slider">
                            <div v-for="(image, index) in product?.images" :key="image.id">
                                <img :src="`${baseUrl}/${image.url_image}`" alt="product" class="w-full"
                                    :class="activeImage === index ? '' : 'hidden'">
                            </div>
                        </div>

                        <div class="product-dtls-nav">
                            <div v-for="(image, index) in product?.images" :key="image.id">
                                <img :src="`${baseUrl}/${image.url_image}`" @click="activeImage = index"
                                    alt="product" class="mb-2 cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:max-w-[635px] w-full">
                    <div class="pb-4 sm:pb-6 border-b border-bdr-clr dark:border-bdr-clr-drk">
                        <h2 class="font-semibold leading-none">
                            {{ product && product.name ? product.name : 'No especificado' }}
                        </h2>
                        <div class="flex gap-4 items-center mt-[15px]">
                            <!--  <span
                                class="text-lg sm:text-xl leading-none pb-[5px] text-title line-through pl-2 inline-block dark:text-white">$140.99</span> -->
                            <span class="text-2xl sm:text-3xl text-primary leading-none block">
                                ${{ product?.presentations[selectedPresentationIndex]?.unit_price }}
                            </span>
                        </div>

                        <p class="sm:text-lg mt-5 md:mt-7">
                            {{ product?.description }}
                        </p>
                    </div>
                    <div class="py-4 sm:py-6 border-b border-bdr-clr dark:border-bdr-clr-drk" data-aos="fade-up"
                        data-aos-delay="200">

                        <IncrementDecrement @update:count="handleCountUpdate" />

                        <div class="flex gap-4 mt-4 sm:mt-6">
                            <Button class="btn btn-solid" data-text="Add to Cart" @click="addToCart">
                                <span>Add to Cart</span>
                            </Button>
                            <router-link to="#" class="btn btn-outline" data-text="Add to Wishlist">
                                <span>Add to Wishlist</span>
                            </router-link>
                        </div>
                    </div>
                    <div class="py-4 sm:py-6 border-b border-bdr-clr dark:border-bdr-clr-drk" data-aos="fade-up"
                        data-aos-delay="300">
                        <div class="flex flex-col sm:flex-row gap-y-4 gap-x-12 lg:gap-x-24 mt-5 sm:mt-10 items-start">
                            <div class="flex items-center gap-3">
                                <h6 class="leading-none font-medium whitespace-nowrap">Medida:</h6>
                                <div class="flex gap-3 flex-wrap">
                                    <label class="product-size cursor-pointer"
                                        v-for="(size, index) in product?.presentations" :key="index">
                                        <input class="appearance-none hidden" type="radio" name="size"
                                            :checked="index === 0" @click="changePrice(index)">
                                        <span
                                            class="px-6 py-2 rounded-lg uppercase flex items-center justify-center leading-none bg-[#E8E9EA] dark:bg-dark-secondary text-title dark:text-white duration-300 hover:bg-primary hover:text-white transition-all">
                                            {{ size.amount }}&nbsp;{{ size.unit_measurement }}
                                        </span>

                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="py-4 sm:py-6 border-b border-bdr-clr dark:border-bdr-clr-drk" data-aos="fade-up"
                        data-aos-delay="400">
                        <h4 class="font-medium leading-none">Tags :</h4>
                        <div class="flex flex-wrap gap-[10px] md:gap-[15px] mt-5 md:mt-6">
                            <router-link class="btn btn-theme-outline btn-xs" to="#"
                                :data-text="product?.category_product.name">
                                <span>
                                    {{ product?.category_product.name }}
                                </span>
                            </router-link>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="s-py-50">
        <DetailTab :description="product?.description" classList="" />
    </div>

</template>
<script setup lang="ts">
import { computed, onMounted, ref, watch } from 'vue'
import { useRouter } from 'vue-router'
import { useRoute } from 'vue-router'
import Aos from 'aos'

import { useProductByIdQuery } from '../composable/useProductsQuery'
import { useAuthStore } from '@/modules/auth/stores/auth'

import IncrementDecrement from '../components/IncrementDecrement.vue'
import DetailTab from '@/modules/common/components/DetailTab.vue'
import { useCartStore } from '../stores/cart';

const router = useRouter()
const cartStore = useCartStore()

// Constantes
const baseUrl = import.meta.env.VITE_BACKEND_STORAGE_URL
const authStore = useAuthStore()

// Ruta y producto actual
const route = useRoute()
const productId = computed(() => route.params.id?.toString() ?? '')
const { data: product, } = useProductByIdQuery(productId.value)

// Estados
const activeImage = ref(1)
const selectedQuantity = ref(1)
const selectedPresentationIndex = ref(0)

// Cuenta regresiva
const now = ref(Date.now())
const targetTime = ref(new Date('Sep 13 2025').getTime())
const difference = ref(targetTime.value - now.value)

watch(now, () => {
    difference.value = targetTime.value - now.value
})
setInterval(() => { now.value = Date.now() }, 1000)

// Hooks
onMounted(() => {
    Aos.init()
})

// Eventos
function handleCountUpdate(value: number) {
    selectedQuantity.value = value
}

function changePrice(index: number) {
    selectedPresentationIndex.value = index
}

// LÃ³gica para el carrito
import { nextTick } from 'vue'

async function addToCart() {
    await nextTick()
    const user = authStore.user
    const productData = product.value

    if (!user || !productData) {
        router.push('/auth/login')
        return
    }

    const price = productData.presentations[selectedPresentationIndex.value].unit_price
    const presentationId = productData.presentations[selectedPresentationIndex.value].id

    cartStore.addItem(productData.id, presentationId, price, selectedQuantity.value)

    alert('Producto agregado al carrito')
}


</script>



<style lang="scss" scoped></style>
